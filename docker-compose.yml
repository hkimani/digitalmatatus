version: "3"

services:
  # faredm:
  #   restart: unless-stopped
  #   build:
  #     context: ./fe
  #     dockerfile: Dockerfile
  #   environment:
  #     - ENV
  #     - JWT
  #     - CERTKEY
  #     - CERTCHAIN
  #   volumes:
  #     - /etc/letsencrypt:/etc/nginx/certs/
  #   ports:
  #     - 80:80
  #     - 443:443
  #   depends_on:
  #     - db
  #     - api
  # api:
  #   restart: unless-stopped
  #   build:
  #     context: ./api
  #     dockerfile: Dockerfile
  #   environment:
  #     - ENV
  #     - JWT
  #     - CERTKEY
  #     - CERTCHAIN
  #   network_mode: "host"
  #   command: ["node", "index.js"]
  #   volumes:
  #     - /etc/letsencrypt/live/weskool.team:/etc/letsencrypt/live/weskool.team/
  #     - /etc/letsencrypt/archive/weskool.team:/etc/letsencrypt/archive/weskool.team/
  #   depends_on:
  #     - db


  # Mongo DB server
  mongodb:
    container_name: mongo-dm
    restart: unless-stopped
    image: mongo
    network_mode: "host"
    environment:
      - MONGO_INITDB_ROOT_USERNAME
      - MONGO_INITDB_ROOT_PASSWORD
    volumes:
      - ~/projs/digitalmatatus/db/nodes/rdb1:/data/db

  # Mariadb server
  # ... Remember to give it some time to start up
  # ... Like 3 Minutes
  sqldb:
    # command: --init-file /data/application/init.sql
    image: mariadb
    restart: unless-stopped
    # volumes:
    #     - ./db/sql/init.sql:/data/application/init.sql
    environment:
      - MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE
    ports:
      - "3306:3306"

  # phpmyadmin
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    restart: unless-stopped
    environment:
      - PMA_HOST=sqldb
      - MYSQL_ROOT_PASSWORD
    ports:
      - "8081:80"
    depends_on:
      - sqldb
  
  # Api for the GTFS data
  django:
    build:
      context: ./django
      dockerfile: Dockerfile
    command: /bin/sh /code/scripts/entrypoint.sh
    environment:
      - USER_EMAIL
      - PROJECT_NAME
      - ENV=Production
      - MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE
      - MYSQL_USER
    # volumes: 
    #   ./django/:/code
    ports: 
      - "8000:8000"
    depends_on: 
      - sqldb
